<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>VPN Gate 服务器列表</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            padding: 20px;
            background: #f5f5f5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            margin-bottom: 20px;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            color: white;
        }

        .test-all-btn {
            background: #4CAF50;
        }

        .test-all-btn:hover:not(:disabled) {
            background: #45a049;
        }

        .show-tested-btn {
            background: #2196F3;
        }

        .show-tested-btn:hover:not(:disabled) {
            background: #1976D2;
        }

        .filter-input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            min-width: 200px;
        }

        .server-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .server-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .server-info {
            font-size: 14px;
            margin-bottom: 15px;
        }

        .server-info p {
            margin: 8px 0;
            display: flex;
            justify-content: space-between;
        }

        .test-btn, .download-btn {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
            color: white;
            transition: background-color 0.3s;
        }

        .test-btn {
            background: #4CAF50;
        }

        .download-btn {
            background: #2196F3;
        }

        .test-btn:hover:not(:disabled) {
            background: #45a049;
        }

        .download-btn:hover:not(:disabled) {
            background: #1976D2;
        }

        .btn:disabled, .test-btn:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }

        .test-result {
            margin-top: 10px;
            padding: 8px;
            border-radius: 4px;
            font-size: 14px;
            text-align: center;
        }

        .test-pending {
            background: #fff3e0;
            color: #ef6c00;
        }

        .test-success {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .test-failed {
            background: #ffebee;
            color: #c62828;
        }

        .stats {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
            display: none;
        }

        @media (max-width: 600px) {
            .controls {
                flex-direction: column;
            }

            .btn, .filter-input {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>VPN Gate 服务器列表</h1>
            <div id="updateTime"></div>
        </div>

        <div class="stats">
            <h3>节点统计</h3>
            <p>总节点数：<span id="totalServers">0</span></p>
            <p>测试成功：<span id="successfulTests">0</span></p>
            <p>成功率：<span id="successRate">0%</span></p>
        </div>

        <div class="controls">
            <button id="testAllBtn" class="btn test-all-btn">测试所有节点</button>
            <button id="showTestedBtn" class="btn show-tested-btn">仅显示测试成功的节点</button>
            <input type="text" id="countryFilter" class="filter-input" placeholder="按国家筛选">
        </div>

        <div id="loading" class="loading">加载中...</div>
        <div id="serverGrid" class="server-grid"></div>
    </div>

    <script>
        // 直接进行初始数据加载测试
        fetch('vpn_data.json')
            .then(response => response.text())
            .then(text => {
                try {
                    const data = JSON.parse(text);
                    console.log('Initial data load:', data);
                } catch (e) {
                    console.error('Parse error:', e);
                }
            })
            .catch(error => console.error('Fetch error:', error));

        class VPNGateUI {
            constructor() {
                this.servers = [];
                this.testedServers = new Map();
                this.showOnlyTested = false;
                this.isTesting = false;
                this.setupEventListeners();
                this.loadData();
            }

            setupEventListeners() {
                document.getElementById('testAllBtn').addEventListener('click', () => this.testAllServers());
                document.getElementById('showTestedBtn').addEventListener('click', () => this.toggleTestedOnly());
                document.getElementById('countryFilter').addEventListener('input', () => this.filterServers());
            }

            showLoading(show) {
                document.getElementById('loading').style.display = show ? 'block' : 'none';
            }

            async loadData() {
    try {
        this.showLoading(true);
        console.log('开始加载数据...');
        
        // 尝试不同的路径
        const urls = [
            './vpn_data.json',
            '/vpngate-servers/vpn_data.json',
            'vpn_data.json'
        ];
        
        let response;
        for (const url of urls) {
            try {
                console.log('尝试加载:', url);
                response = await fetch(url, {
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    },
                    cache: 'no-store'
                });
                if (response.ok) break;
            } catch (e) {
                console.log('加载失败:', url, e);
            }
        }
        
        if (!response || !response.ok) {
            throw new Error('无法加载数据文件');
        }
        
        const text = await response.text();
        console.log('原始数据:', text.substring(0, 200));
        
        const data = JSON.parse(text);
        console.log('解析后的数据:', data);
        
        if (!data || !Array.isArray(data.servers)) {
            throw new Error('数据格式不正确');
        }
        
        this.servers = data.servers;
        console.log('服务器数量:', this.servers.length);
        
        document.getElementById('totalServers').textContent = this.servers.length;
        
        if (data.timestamp) {
            const updateTime = new Date(data.timestamp * 1000);
            document.getElementById('updateTime').textContent = 
                `更新时间: ${updateTime.toLocaleString()}`;
        }
        
        this.filterServers();
    } catch (error) {
        console.error('加载数据失败:', error);
        alert('加载服务器列表失败：' + error.message);
    } finally {
        this.showLoading(false);
    }
}

            async testServer(ip, cardElement) {
                const testResultElement = cardElement.querySelector('.test-result');
                const testButton = cardElement.querySelector('.test-btn');
                testButton.disabled = true;
                testResultElement.textContent = '测试中...';
                testResultElement.className = 'test-result test-pending';

                const testUrls = [
                    'https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js',
                    'https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js',
                    'https://cdnjs.cloudflare.com/ajax/libs/react/17.0.2/umd/react.production.min.js'
                ];

                try {
                    const startTime = performance.now();
                    const testPromises = testUrls.map(url => 
                        fetch(url, { 
                            mode: 'no-cors',
                            cache: 'no-store'
                        })
                    );

                    await Promise.any(testPromises);
                    const endTime = performance.now();
                    const latency = Math.round(endTime - startTime);
                    
                    this.testedServers.set(ip, {
                        status: 'success',
                        latency,
                        testedAt: new Date().toISOString()
                    });

                    testResultElement.textContent = `测试成功! 延迟: ${latency}ms`;
                    testResultElement.className = 'test-result test-success';
                    
                    this.updateStats();
                    if (this.showOnlyTested) this.filterServers();
                } catch (error) {
                    this.testedServers.set(ip, {
                        status: 'failed',
                        error: error.message,
                        testedAt: new Date().toISOString()
                    });
                    testResultElement.textContent = '测试失败';
                    testResultElement.className = 'test-result test-failed';
                } finally {
                    testButton.disabled = false;
                }
            }

            async testAllServers() {
                if (this.isTesting) return;

                this.isTesting = true;
                const testAllBtn = document.getElementById('testAllBtn');
                testAllBtn.disabled = true;
                testAllBtn.textContent = '测试中...';

                const cards = document.querySelectorAll('.server-card');
                for (const card of cards) {
                    if (this.isTesting) {
                        const ip = card.getAttribute('data-ip');
                        if (!this.testedServers.has(ip) || 
                            this.testedServers.get(ip).status === 'failed') {
                            await this.testServer(ip, card);
                            await new Promise(resolve => setTimeout(resolve, 500));
                        }
                    }
                }

                this.isTesting = false;
                testAllBtn.disabled = false;
                testAllBtn.textContent = '测试所有节点';
            }

            toggleTestedOnly() {
                const btn = document.getElementById('showTestedBtn');
                this.showOnlyTested = !this.showOnlyTested;
                btn.textContent = this.showOnlyTested ? '显示所有节点' : '仅显示测试成功的节点';
                this.filterServers();
            }

            updateStats() {
                const totalTested = this.testedServers.size;
                const successfulTests = Array.from(this.testedServers.values())
                    .filter(result => result.status === 'success').length;
                
                document.getElementById('successfulTests').textContent = successfulTests;
                document.getElementById('successRate').textContent = 
                    totalTested ? `${Math.round(successfulTests / totalTested * 100)}%` : '0%';
            }

            filterServers() {
                const countryFilter = document.getElementById('countryFilter').value.toLowerCase();
                let filteredServers = this.servers;

                if (countryFilter) {
                    filteredServers = filteredServers.filter(server => 
                        server.countryLong.toLowerCase().includes(countryFilter)
                    );
                }

                if (this.showOnlyTested) {
                    filteredServers = filteredServers.filter(server => 
                        this.testedServers.has(server.ip) && 
                        this.testedServers.get(server.ip).status === 'success'
                    );
                }

                this.displayServers(filteredServers);
            }

            displayServers(servers) {
                const grid = document.getElementById('serverGrid');
                grid.innerHTML = '';

                if (servers.length === 0) {
                    grid.innerHTML = '<p style="text-align: center; grid-column: 1/-1;">没有找到符合条件的节点</p>';
                    return;
                }

                servers.forEach(server => {
                    const speed = (parseInt(server.speed) / 1024 / 1024).toFixed(2);
                    const card = document.createElement('div');
                    card.className = 'server-card';
                    card.setAttribute('data-ip', server.ip);

                    const testResult = this.testedServers.get(server.ip);
                    const testResultHtml = testResult ? `
                        <div class="test-result ${testResult.status === 'success' ? 'test-success' : 'test-failed'}">
                            ${testResult.status === 'success' ? 
                                `测试成功! 延迟: ${testResult.latency}ms` : 
                                '测试失败'}
                        </div>
                    ` : '';

                    card.innerHTML = `
                        <div class="server-info">
                            <h3>${server.countryLong}</h3>
                            <p>IP: ${server.ip}</p>
                            <p>速度: ${speed} Mbps</p>
                            <p>Ping: ${server.ping} ms</p>
                            <p>在线用户: ${server.numVpnSessions}</p>
                        </div>
                        ${testResultHtml}
                        <button class="test-btn" onclick="vpnUI.testServer('${server.ip}', this.parentElement)">
                            测试连接
                        </button>
                        <button class="download-btn" onclick="vpnUI.downloadConfig('${server.ip}', '${encodeURIComponent(server.configData)}')">
                            下载配置文件
                        </button>
                    `;
                    grid.appendChild(card);
                });
            }

            downloadConfig(ip, configData) {
                try {
                    const decodedConfigData = decodeURIComponent(configData);
                    const base64Content = decodedConfigData.replace(/[\r\n]/g, '');
                    const config = atob(base64Content);
                    
                    const blob = new Blob([config], { type: 'text/plain;
